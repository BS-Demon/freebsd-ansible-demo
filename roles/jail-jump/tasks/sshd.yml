---
- name: Enable sshd on {{ jail_name }}
  lineinfile:
    dest: '{{ jail_home.stdout }}/etc/rc.conf'
    state: 'present'
    regexp: '^sshd_enable='
    line: 'sshd_enable=\"YES\"'

- name: Create .ssh directry for ansible user on {{ jail_name }}
  file:
    path: '{{ jail_home.stdout }}/home/{{ ssh_user }}/.ssh'
    owner: '{{ ssh_user }}'
    group: '{{ ssh_user }}'
    mode: 0700
    state: directory

- name: Add trusted ssh key to authorized_hosts on {{ jail_name }}
  copy:
    dest: '{{ jail_home.stdout }}/home/{{ ssh_user }}/.ssh/authorized_keys'
    owner: '{{ ssh_user }}'
    group: '{{ ssh_user }}'
    content: '{{ ssh_pub_key }}'

- name: Make adjustments to sshd (allowed user, port, authentication, ..)
  lineinfile:
    dest: '{{ jail_home.stdout }}/etc/ssh/sshd_config'
    state: 'present'
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
    insertbefore: '^#Port'
  with_items:
  - { regexp: '^Port', line: 'Port {{ sshd_port }}' }
  - { regexp: '^ListenAddress', line: 'ListenAddress {{ jail_ip }}' }
  - { regexp: '^Protocol', line: 'Protocol 2' }
  - { regexp: '^AllowUsers', line: 'AllowUsers {{ ssh_user }}'}
  - { regexp: '^MaxStartups', line: 'MaxStartups 5:50:10' }
  - { regexp: '^LoginGraceTime', line: 'LoginGraceTime 30' }
  - { regexp: '^ChallengeResponseAuthentication',
      line: 'ChallengeResponseAuthentication no' }
  - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
  - { regexp: '^UseDNS', line: 'UseDNS no' }
  - { regexp: '^UsePAM', line: 'UsePAM no' }
  - { regexp: '^ClientAliveInterval', line: 'ClientAliveInterval 30' }
  notify:
    - reload {{ jail_name }} s sshd

